ARG NIGHTLY_DATE="20250730"
ARG BASE_IMAGE="us-central1-docker.pkg.dev/tpu-pytorch-releases/docker/xla:nightly_3.12_tpuvm_$NIGHTLY_DATE"

FROM $BASE_IMAGE
WORKDIR /workspace/vllm

# Install basic utilities
RUN apt-get update && apt-get install -y \
    git \
    ffmpeg libsm6 libxext6 libgl1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Build vLLM.
COPY . .
ARG GIT_REPO_CHECK=0
RUN --mount=type=bind,source=.git,target=.git \
    if [ "$GIT_REPO_CHECK" != 0 ]; then bash tools/check_repo.sh; fi

# Remove existing versions of dependencies that may be preinstalled
RUN pip uninstall -y torch torch_xla torchvision || true

# Target device is TPU
ENV VLLM_TARGET_DEVICE="tpu"
ENV PYTHONUNBUFFERED=1

# Install TPU requirements
RUN --mount=type=cache,target=/root/.cache/pip \
    python3 -m pip install -r requirements/tpu.txt

# Install vLLM
RUN --mount=type=cache,target=/root/.cache/pip \
    python3 -m pip install -e .

# Expose OpenAI API server port
EXPOSE 8000

# Healthcheck uses OpenAI server health endpoint
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
  CMD curl -fsS http://localhost:8000/health || exit 1

# Start the OpenAI-compatible API server
ENTRYPOINT ["python3", "-m", "vllm.entrypoints.openai.api_server"]
